<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoDesignAI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1a0f;
            --card: #172219;
            --border: #243626;
            --accent: #4ade80;
            --accent-dim: #2d7a47;
            --accent-glow: rgba(74, 222, 128, 0.15);
            --text: #e8f5e9;
            --text-muted: #6b8f72;
            --text-dim: #3d5c42;
            --bot-bubble: #1a2e1d;
            --user-bubble: #1e3a22;
            --danger: #f87171;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat header (shown inside iframe) */
        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            background: rgba(13,26,15,0.95);
        }

        .chat-header .logo-dot {
            width: 28px; height: 28px;
            background: var(--accent);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
            box-shadow: 0 0 12px rgba(74,222,128,0.3);
        }

        .chat-header h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 0.95rem;
            color: var(--text);
        }
        .chat-header h2 span { color: var(--accent); }

        .status-dot {
            width: 7px; height: 7px;
            background: var(--accent);
            border-radius: 50%;
            margin-left: auto;
            box-shadow: 0 0 6px var(--accent);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

        /* Chat box */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 16px 14px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        #chat-box::-webkit-scrollbar { width: 3px; }
        #chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .message-row {
            display: flex;
            gap: 9px;
            animation: slideIn .22s ease-out;
        }
        .message-row.user { flex-direction: row-reverse; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .avatar {
            width: 26px; height: 26px;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            margin-top: 2px;
        }
        .avatar.bot  { background: var(--accent-dim); color: var(--bg); }
        .avatar.user { background: var(--border); color: var(--text-muted); }

        .bubble {
            max-width: 82%;
            padding: 10px 13px;
            border-radius: 10px;
            font-size: 0.76rem;
            line-height: 1.75;
        }
        .bubble.bot  {
            background: var(--bot-bubble);
            border: 1px solid var(--border);
            border-top-left-radius: 2px;
        }
        .bubble.user {
            background: var(--user-bubble);
            border: 1px solid var(--accent-dim);
            border-top-right-radius: 2px;
            color: var(--accent);
        }

        /* Clarification card */
        .clar-card {
            background: var(--card);
            border: 1px solid var(--accent-dim);
            border-radius: 9px;
            padding: 11px 13px;
            margin-top: 7px;
        }
        .clar-label {
            font-size: 0.6rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: .1em;
            margin-bottom: 5px;
        }
        .clar-card p { font-size: 0.76rem; color: var(--text); margin-bottom: 7px; }

        /* Material option chips */
        .options-list { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .option-chip {
            background: rgba(74,222,128,.04);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 7px 10px;
            font-size: 0.72rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all .14s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .option-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
        .option-chip .mat-name { color: var(--text); font-weight: 500; }
        .score-badge {
            font-size: 0.62rem; padding: 2px 6px;
            border-radius: 4px; background: rgba(74,222,128,.1); color: var(--accent);
        }

        /* Recommendation card */
        .rec-card {
            background: var(--card);
            border: 1px solid var(--accent-dim);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 7px;
        }
        .rec-head {
            background: rgba(74,222,128,.07);
            padding: 9px 13px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 7px;
        }
        .rec-tag {
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: .1em;
            color: var(--accent); background: rgba(74,222,128,.1);
            padding: 2px 7px; border-radius: 4px;
        }
        .rec-product {
            font-family: 'DM Serif Display', serif;
            font-size: 0.92rem; color: var(--text);
        }
        .rec-body { padding: 11px 13px; display: flex; flex-direction: column; gap: 9px; }

        .mat-spot { display: flex; align-items: center; gap: 9px; }
        .mat-icon {
            width: 36px; height: 36px;
            background: rgba(74,222,128,.1);
            border: 1px solid var(--accent-dim);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
        }
        .mat-name-big { font-family: 'DM Serif Display', serif; font-size: 0.95rem; color: var(--accent); text-transform: capitalize; }
        .mat-type-sm  { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .08em; margin-top: 1px; }

        .stats-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 5px; }
        .stat {
            background: rgba(255,255,255,.02);
            border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 8px; text-align: center;
        }
        .stat .v { font-size: 0.85rem; color: var(--accent); font-weight: 500; }
        .stat .k { font-size: 0.56rem; color: var(--text-muted); margin-top: 2px; text-transform: uppercase; letter-spacing: .08em; }

        .explanation {
            font-size: 0.7rem; color: var(--text-muted); line-height: 1.75;
            border-left: 2px solid var(--accent-dim); padding-left: 10px;
        }

        .gen-img { width: 100%; border-radius: 7px; border: 1px solid var(--border); display: block; }
        .img-cap { font-size: 0.58rem; color: var(--text-dim); text-align: center; margin-top: 4px; text-transform: uppercase; letter-spacing: .1em; }

        .top3-title { font-size: 0.61rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .1em; margin-bottom: 4px; }
        .top3-grid  { display: grid; grid-template-columns: repeat(3,1fr); gap: 4px; }
        .top3-item  {
            background: rgba(255,255,255,.02); border: 1px solid var(--border);
            border-radius: 5px; padding: 6px; text-align: center;
            font-size: 0.65rem; color: var(--text-muted);
        }
        .top3-item:first-child { border-color: var(--accent-dim); color: var(--accent); }
        .top3-item .t3m { font-weight: 500; text-transform: capitalize; margin-bottom: 2px; }
        .top3-item .t3s { font-size: 0.58rem; opacity: .7; }

        .err-bubble {
            background: rgba(248,113,113,.07);
            border: 1px solid rgba(248,113,113,.3);
            border-radius: 7px; padding: 8px 12px;
            font-size: 0.72rem; color: var(--danger); margin-top: 5px;
        }

        .eco-warning {
            background: rgba(250, 204, 21, 0.07);
            border: 1px solid rgba(250, 204, 21, 0.35);
            border-radius: 7px;
            padding: 10px 13px;
            font-size: 0.72rem;
            color: #fde68a;
            line-height: 1.7;
            margin-bottom: 8px;
        }
        .eco-warning strong {
            color: #fbbf24;
            display: block;
            margin-bottom: 4px;
        }

        /* Typing dots */
        .typing { display: flex; align-items: center; gap: 4px; padding: 10px 13px; }
        .typing span {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent-dim);
            animation: bounce 1.2s ease-in-out infinite;
        }
        .typing span:nth-child(2) { animation-delay: .2s; }
        .typing span:nth-child(3) { animation-delay: .4s; }
        @keyframes bounce { 0%,80%,100%{transform:translateY(0);opacity:.4} 40%{transform:translateY(-5px);opacity:1} }

        /* Input bar */
        .input-bar {
            padding: 10px 12px 12px;
            border-top: 1px solid var(--border);
            display: flex; gap: 7px; align-items: flex-end;
            background: rgba(13,26,15,.9);
            flex-shrink: 0;
        }

        #user-input {
            flex: 1;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 9px 12px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.76rem;
            outline: none;
            resize: none;
            transition: border-color .2s;
            line-height: 1.5;
            max-height: 80px;
            overflow-y: auto;
        }
        #user-input:focus { border-color: var(--accent-dim); }
        #user-input::placeholder { color: var(--text-dim); }

        #send-btn {
            background: var(--accent);
            border: none; border-radius: 8px;
            padding: 9px 15px;
            color: var(--bg);
            font-family: 'DM Mono', monospace;
            font-size: 0.73rem; font-weight: 500;
            cursor: pointer; transition: all .14s;
            white-space: nowrap;
        }
        #send-btn:hover { background: #86efac; box-shadow: 0 0 12px rgba(74,222,128,.35); }
        #send-btn:disabled { background: var(--text-dim); cursor: not-allowed; box-shadow: none; }

        .chat-hint {
            font-size: 0.58rem; color: var(--text-dim);
            text-align: center; padding: 3px 0 7px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

<div class="chat-header">
    <div class="logo-dot">ğŸŒ¿</div>
    <h2>Eco<span>Design</span>AI</h2>
    <div class="status-dot"></div>
</div>

<div id="chat-box">
    <div class="message-row bot">
        <div class="avatar bot">ğŸŒ¿</div>
        <div class="bubble bot">
            Hello! I'm your <strong style="color:var(--accent)">EcoDesignAI</strong> assistant.<br><br>
            Tell me what you'd like to design, or click
            <strong style="color:var(--accent)">"Design with this material â†’"</strong>
            on the left panel to start instantly.
        </div>
    </div>
</div>

<div class="input-bar">
    <textarea id="user-input" placeholder="Describe your product..." rows="1"
        onkeydown="handleKey(event)"
        oninput="autoResize(this)"></textarea>
    <button id="send-btn" onclick="sendMessage()">Send â†‘</button>
</div>
<div class="chat-hint">Enter to send Â· Shift+Enter for new line</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// postMessage listener â€” studio.js sends INJECT_MESSAGE here
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('message', (event) => {
    // Security: only accept messages from same origin
    if (event.origin !== window.location.origin) return;

    if (event.data && event.data.type === 'INJECT_MESSAGE') {
        const text = event.data.text;
        if (!text) return;

        // Put text in input visibly for 350ms then auto-send
        const input = document.getElementById('user-input');
        input.value = text;
        autoResize(input);

        setTimeout(() => sendMessage(), 350);
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 80) + 'px';
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function scrollBottom() {
    const box = document.getElementById('chat-box');
    box.scrollTop = box.scrollHeight;
}

function appendMsg(role, content) {
    const box = document.getElementById('chat-box');
    const row = document.createElement('div');
    row.className = `message-row ${role}`;

    const av = document.createElement('div');
    av.className = `avatar ${role}`;
    av.textContent = role === 'bot' ? 'ğŸŒ¿' : 'â—';

    const bub = document.createElement('div');
    bub.className = `bubble ${role}`;
    if (typeof content === 'string') bub.innerHTML = content;
    else bub.appendChild(content);

    row.appendChild(av);
    row.appendChild(bub);
    box.appendChild(row);
    scrollBottom();
}

function showTyping() {
    const box = document.getElementById('chat-box');
    const row = document.createElement('div');
    row.className = 'message-row bot'; row.id = 'typing-row';
    const av = document.createElement('div');
    av.className = 'avatar bot'; av.textContent = 'ğŸŒ¿';
    const bub = document.createElement('div');
    bub.className = 'bubble bot';
    bub.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
    row.appendChild(av); row.appendChild(bub);
    box.appendChild(row); scrollBottom();
}

function removeTyping() {
    const el = document.getElementById('typing-row');
    if (el) el.remove();
}

function matEmoji(m) {
    const map = { bamboo:'ğŸ‹',wood:'ğŸªµ',cotton:'ğŸŒ¿',hemp:'ğŸŒ±',aluminum:'âš™ï¸',
                  steel:'ğŸ”©',glass:'ğŸ’',plastic:'â™»ï¸',cork:'ğŸ¾',ceramic:'ğŸº',
                  paper:'ğŸ“„',linen:'ğŸ§µ',bioplastic:'ğŸŒ¾',mycelium:'ğŸ„' };
    for (const [k,v] of Object.entries(map)) {
        if (m && m.toLowerCase().includes(k)) return v;
    }
    return 'ğŸŒ¿';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render API response
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResponse(data) {
    const w = document.createElement('div');

    if (data.error) {
        w.innerHTML = `<div class="err-bubble">âš ï¸ ${data.error}</div>`;
        return w;
    }

    // Simple clarification (no options)
    if (data.clarification && !data.options) {
        const c = document.createElement('div');
        c.className = 'clar-card';
        c.innerHTML = `<div class="clar-label">Need more info</div><p>${data.clarification}</p>`;
        w.appendChild(c);
        return w;
    }

    // Material options â€” clickable chips
    if (data.clarification && data.options) {
        const c = document.createElement('div');
        c.className = 'clar-card';
        c.innerHTML = `<div class="clar-label">Choose a material</div><p>${data.clarification}</p>`;

        const list = document.createElement('div');
        list.className = 'options-list';

        data.options.forEach((opt, i) => {
            const chip = document.createElement('div');
            chip.className = 'option-chip';
            chip.innerHTML = `
                <span>${i === 0 ? 'â­ ' : ''}<span class="mat-name">${opt.material.replace(/_/g,' ')}</span></span>
                <span style="display:flex;gap:4px">
                    <span class="score-badge">eco ${opt.eco_score ?? 'â€”'}</span>
                    <span class="score-badge">COâ‚‚ ${opt.carbon_score ?? 'â€”'}</span>
                    <span class="score-badge">${opt.durability ?? 'â€”'}</span>
                </span>`;
            chip.addEventListener('click', () => {
                document.getElementById('user-input').value = opt.material.replace(/_/g,' ');
                sendMessage();
            });
            list.appendChild(chip);
        });

        c.appendChild(list);
        w.appendChild(c);
        return w;
    }

    // Final recommendation
    const rec      = data.final_recommendation || data;
    const mat      = rec.recommended_material;
    const prod     = rec.product || data.product;
    const expl     = rec.decision_explanation || data.decision_explanation;
    const top3     = rec.top_3_options || data.top_3_options;
    const img      = data.image_url;
    const ecoWarn  = data.eco_warning || rec.eco_warning;

    if (!mat && !expl) {
        w.innerHTML = `<pre style="font-size:.68rem;color:var(--text-muted);white-space:pre-wrap">${JSON.stringify(data,null,2)}</pre>`;
        return w;
    }

    const card = document.createElement('div');
    card.className = 'rec-card';
    card.innerHTML = `
        <div class="rec-head">
            <span class="rec-tag">Recommendation</span>
            <span class="rec-product">${(prod||'Product').replace(/_/g,' ')}</span>
        </div>`;

    const body = document.createElement('div');
    body.className = 'rec-body';

    if (mat) {
        body.innerHTML = `
            <div class="mat-spot">
                <div class="mat-icon">${matEmoji(mat.material)}</div>
                <div>
                    <div class="mat-name-big">${(mat.material||'').replace(/_/g,' ')}</div>
                    <div class="mat-type-sm">${mat.material_type||''}</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat"><div class="v">${mat.eco_score??'â€”'}</div><div class="k">Eco</div></div>
                <div class="stat"><div class="v">${mat.carbon_score??'â€”'}</div><div class="k">Carbon</div></div>
                <div class="stat"><div class="v">${mat.durability??'â€”'}</div><div class="k">Durability</div></div>
                <div class="stat"><div class="v">${mat.recyclable??'â€”'}</div><div class="k">Recyclable</div></div>
                <div class="stat"><div class="v">${mat.biodegradable??'â€”'}</div><div class="k">Biodegrad.</div></div>
                <div class="stat"><div class="v">${mat.cost_level??'â€”'}</div><div class="k">Cost</div></div>
            </div>`;
    }

    // Eco warning â€” shown when user forced a non-eco material
    if (ecoWarn) {
        const wb = document.createElement('div');
        wb.className = 'eco-warning';
        wb.innerHTML = `<strong>âš ï¸ Eco Notice</strong>${ecoWarn.replace(/\n/g,'<br>')}`;
        body.appendChild(wb);
    }

    if (expl) {
        const lines = expl.split('\n')
            .filter(l => l.trim() && !l.startsWith('For designing'))
            .map(l => l.replace(/^â€¢\s*/,''))
            .join('<br>');
        body.innerHTML += `<div class="explanation">${lines}</div>`;
    }

    if (top3 && top3.length > 1) {
        const t3 = document.createElement('div');
        t3.innerHTML = `<div class="top3-title">Top alternatives</div>`;
        const tg = document.createElement('div');
        tg.className = 'top3-grid';
        top3.forEach((m, i) => {
            tg.innerHTML += `
                <div class="top3-item">
                    <div class="t3m">${i===0?'â˜… ':''}${(m.material||'').replace(/_/g,' ')}</div>
                    <div class="t3s">eco ${m.eco_score} Â· ${m.durability}</div>
                </div>`;
        });
        t3.appendChild(tg);
        body.appendChild(t3);
    }

    if (img) {
        const el = document.createElement('img');
        el.className = 'gen-img'; el.src = img;
        el.alt = `${prod} concept`;
        el.onerror = () => el.style.display = 'none';
        body.appendChild(el);
        const cap = document.createElement('div');
        cap.className = 'img-cap';
        cap.textContent = `AI-generated Â· ${(mat?.material||'').replace(/_/g,' ')} ${prod}`;
        body.appendChild(cap);
    }

    card.appendChild(body);
    w.appendChild(card);
    return w;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Send message to /design API
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
    const input = document.getElementById('user-input');
    const btn   = document.getElementById('send-btn');
    const msg   = input.value.trim();
    if (!msg) return;

    appendMsg('user', msg);
    input.value = '';
    input.style.height = 'auto';
    btn.disabled = true;
    showTyping();

    try {
        const res  = await fetch('/design', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: msg })
        });
        const data = await res.json();
        removeTyping();
        appendMsg('bot', renderResponse(data));
    } catch (err) {
        removeTyping();
        appendMsg('bot', `<div class="err-bubble">âš ï¸ Network error: ${err.message}</div>`);
    }

    btn.disabled = false;
    input.focus();
}
</script>

</body>
</html>